# ========================================
# TestHub IoT测试管理平台 - Docker编排配置
# 一键启动所有基础设施：MySQL、Redis、Nacos、EMQX(MQTT)
# 使用方法：docker compose up -d
# ========================================

services:
  # ==================== MySQL数据库 ====================
  mysql:
    image: mysql:8.0
    container_name: testhub-mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root123456
      MYSQL_DATABASE: testhub
      TZ: Asia/Shanghai
    ports:
      - "3306:3306"
    volumes:
      - mysql-data:/var/lib/mysql
      - ./sql/testhub-init.sql:/docker-entrypoint-initdb.d/init.sql
    command:
      --default-authentication-plugin=mysql_native_password
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_general_ci
    networks:
      - testhub-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==================== Redis缓存 ====================
  redis:
    image: redis:7.0-alpine
    container_name: testhub-redis
    restart: always
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    networks:
      - testhub-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==================== Nacos注册+配置中心 ====================
  nacos:
    image: nacos/nacos-server:v2.2.0
    container_name: testhub-nacos
    restart: always
    environment:
      MODE: standalone  # 单机模式
      SPRING_DATASOURCE_PLATFORM: mysql
      MYSQL_SERVICE_HOST: mysql
      MYSQL_SERVICE_PORT: 3306
      MYSQL_SERVICE_DB_NAME: nacos_config
      MYSQL_SERVICE_USER: root
      MYSQL_SERVICE_PASSWORD: root123456
      JVM_XMS: 512m
      JVM_XMX: 512m
      TZ: Asia/Shanghai
    ports:
      - "8848:8848"  # Nacos控制台端口
      - "9848:9848"  # gRPC端口
    volumes:
      - nacos-data:/home/nacos/data
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - testhub-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8848/nacos/actuator/health"]
      interval: 15s
      timeout: 5s
      retries: 10

  # ==================== EMQX MQTT消息代理 ====================
  emqx:
    image: emqx/emqx:5.3.0
    container_name: testhub-emqx
    restart: always
    environment:
      EMQX_NAME: testhub-emqx
      EMQX_HOST: 127.0.0.1
      EMQX_NODE__COOKIE: testhub_emqx_secret_cookie
      TZ: Asia/Shanghai
    ports:
      - "1883:1883"   # MQTT端口
      - "8883:8883"   # MQTT/SSL端口
      - "8083:8083"   # MQTT/WebSocket端口
      - "18083:18083" # EMQX Dashboard(Web管理界面)
    volumes:
      - emqx-data:/opt/emqx/data
      - emqx-log:/opt/emqx/log
    networks:
      - testhub-network
    healthcheck:
      test: ["CMD", "/opt/emqx/bin/emqx", "ctl", "status"]
      interval: 10s
      timeout: 5s
      retries: 5

# ==================== 数据卷 ====================
volumes:
  mysql-data:
    name: testhub-mysql-data
  redis-data:
    name: testhub-redis-data
  nacos-data:
    name: testhub-nacos-data
  emqx-data:
    name: testhub-emqx-data
  emqx-log:
    name: testhub-emqx-log

# ==================== 网络 ====================
networks:
  testhub-network:
    name: testhub-network
    driver: bridge

# ========================================
# 使用说明：
#
# 1. 启动所有服务：
#    docker-compose up -d
#
# 2. 查看服务状态：
#    docker-compose ps
#
# 3. 查看日志：
#    docker-compose logs -f [服务名]
#
# 4. 停止所有服务：
#    docker-compose down
#
# 5. 停止并删除数据卷：
#    docker-compose down -v
#
# 6. 访问地址：
#    - MySQL: localhost:3306 (root/root123456)
#    - Redis: localhost:6379
#    - Nacos: http://localhost:8848/nacos (nacos/nacos)
#    - EMQX: http://localhost:18083 (admin/public)
#    - MQTT: localhost:1883
# ========================================
